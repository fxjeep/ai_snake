<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="è´ªåƒè›‡æ¸¸æˆ - ç»å…¸æ¸¸æˆï¼Œç°ä»£ä½“éªŒ">
    <title>è´ªåƒè›‡</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- åŠ¨æ€èƒŒæ™¯ -->
    <div class="bg-animation">
        <div class="bg-orb bg-orb--cyan"></div>
        <div class="bg-orb bg-orb--fuchsia"></div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar__user">
            <span class="navbar__user-icon">ğŸ‘¤</span>
            <span class="navbar__user-name" id="userName">æ¸¸å®¢</span>
            <span class="navbar__stats" id="userStats"></span>
        </div>
        <button class="btn btn--ghost" id="logoutBtn">é€€å‡º</button>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="page-container" style="padding-top: 80px;">
        <div class="content-wrapper" style="max-width: 500px;">
            <div class="glass-card">
                <!-- æ ‡é¢˜ -->
                <h1 class="title gradient-text" style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ è´ªåƒè›‡</h1>

                <!-- æ¸¸æˆç”»å¸ƒ -->
                <div class="game-canvas-wrapper">
                    <canvas id="gameCanvas" class="game-canvas" width="400" height="400"></canvas>
                </div>

                <!-- æ¸¸æˆä¿¡æ¯ -->
                <div class="game-info">
                    <div class="game-stat">
                        <div class="game-stat__label">å½“å‰åˆ†æ•°</div>
                        <div class="game-stat__value" id="currentScore">0</div>
                    </div>
                    <div class="game-stat">
                        <div class="game-stat__label">æœ€é«˜åˆ†</div>
                        <div class="game-stat__value" id="highScore">0</div>
                    </div>
                </div>

                <!-- é€Ÿåº¦æ§åˆ¶ -->
                <div class="speed-control">
                    <label class="speed-control__label">
                        <span>ğŸš€ é€Ÿåº¦</span>
                        <span class="speed-control__value" id="speedValue">ä¸­ç­‰</span>
                    </label>
                    <input type="range" id="speedSlider" class="speed-slider" min="1" max="5" value="3">
                    <div class="speed-control__labels">
                        <span>æ…¢</span>
                        <span>å¿«</span>
                    </div>
                </div>

                <!-- æ¸¸æˆæ§åˆ¶ -->
                <div class="game-controls">
                    <p class="game-status" id="gameStatus">æŒ‰ä¸‹ç©ºæ ¼é”®æˆ–ç‚¹å‡»æŒ‰é’®å¼€å§‹</p>
                    <button class="btn btn--primary btn--large" id="startBtn">ğŸ® å¼€å§‹æ¸¸æˆ</button>
                </div>

                <!-- æ’è¡Œæ¦œ -->
                <div class="leaderboard" id="leaderboard">
                    <h3 class="leaderboard__title">ğŸ† æ’è¡Œæ¦œ</h3>
                    <ul class="leaderboard__list" id="leaderboardList">
                        <li class="leaderboard__item">
                            <span class="leaderboard__rank">-</span>
                            <span class="leaderboard__name">æš‚æ— è®°å½•</span>
                            <span class="leaderboard__score">-</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/game.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const currentUser = Auth.getCurrentUser();
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        // DOM å…ƒç´ 
        const userNameEl = document.getElementById('userName');
        const userStatsEl = document.getElementById('userStats');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentScoreEl = document.getElementById('currentScore');
        const highScoreEl = document.getElementById('highScore');
        const gameStatusEl = document.getElementById('gameStatus');
        const startBtn = document.getElementById('startBtn');
        const leaderboardListEl = document.getElementById('leaderboardList');
        const canvas = document.getElementById('gameCanvas');
        const speedSlider = document.getElementById('speedSlider');
        const speedValueEl = document.getElementById('speedValue');

        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        function initUserInfo() {
            if (currentUser) {
                userNameEl.textContent = currentUser.username;
                highScoreEl.textContent = currentUser.highScore || 0;
                if (currentUser.isGuest) {
                    userStatsEl.textContent = '(æ¸¸å®¢æ¨¡å¼)';
                } else {
                    userStatsEl.textContent = `| æ¸¸æˆæ¬¡æ•°: ${currentUser.gamesPlayed || 0}`;
                }
            }
        }

        // æ›´æ–°æ’è¡Œæ¦œæ˜¾ç¤º
        function updateLeaderboard() {
            const leaderboard = Storage.getLeaderboard();

            if (leaderboard.length === 0) {
                leaderboardListEl.innerHTML = `
                    <li class="leaderboard__item">
                        <span class="leaderboard__rank">-</span>
                        <span class="leaderboard__name">æš‚æ— è®°å½•</span>
                        <span class="leaderboard__score">-</span>
                    </li>
                `;
                return;
            }

            leaderboardListEl.innerHTML = leaderboard.map((entry, index) => `
                <li class="leaderboard__item">
                    <span class="leaderboard__rank">#${index + 1}</span>
                    <span class="leaderboard__name">${entry.username}</span>
                    <span class="leaderboard__score">${entry.score}</span>
                </li>
            `).join('');
        }

        // é€Ÿåº¦é…ç½®ï¼ˆå€¼è¶Šå°è¶Šå¿«ï¼‰
        const speedLevels = {
            1: { ms: 200, label: 'å¾ˆæ…¢' },
            2: { ms: 150, label: 'æ…¢' },
            3: { ms: 100, label: 'ä¸­ç­‰' },
            4: { ms: 70, label: 'å¿«' },
            5: { ms: 50, label: 'å¾ˆå¿«' }
        };

        // æ›´æ–°é€Ÿåº¦æ˜¾ç¤º
        function updateSpeedDisplay() {
            const level = speedSlider.value;
            speedValueEl.textContent = speedLevels[level].label;
        }

        // é€Ÿåº¦æ»‘å—äº‹ä»¶
        speedSlider.addEventListener('input', () => {
            updateSpeedDisplay();
            const level = speedSlider.value;
            game.setSpeed(speedLevels[level].ms);
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        const game = new SnakeGame(canvas, {
            onScoreChange: (score) => {
                currentScoreEl.textContent = score;
            },
            onGameOver: (finalScore) => {
                // è§¦å‘éœ‡åŠ¨æ•ˆæœ
                const canvasWrapper = document.querySelector('.game-canvas-wrapper');
                canvasWrapper.classList.add('shake');
                setTimeout(() => canvasWrapper.classList.remove('shake'), 500);

                gameStatusEl.textContent = `æ¸¸æˆç»“æŸï¼å¾—åˆ†: ${finalScore}`;
                startBtn.textContent = 'ğŸ”„ é‡æ–°å¼€å§‹';
                startBtn.classList.remove('hidden');
                speedSlider.disabled = false; // æ¸¸æˆç»“æŸåå¯ç”¨é€Ÿåº¦æ»‘å—

                // æ›´æ–°åˆ†æ•°
                const isNewRecord = Auth.updateScore(finalScore);
                if (isNewRecord) {
                    gameStatusEl.textContent = `ğŸ‰ æ–°çºªå½•ï¼å¾—åˆ†: ${finalScore}`;
                }

                // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯å’Œæ’è¡Œæ¦œ
                const updatedUser = Auth.getCurrentUser();
                if (updatedUser) {
                    highScoreEl.textContent = updatedUser.highScore;
                    if (!updatedUser.isGuest) {
                        userStatsEl.textContent = `| æ¸¸æˆæ¬¡æ•°: ${updatedUser.gamesPlayed || 0}`;
                    }
                }
                updateLeaderboard();
            },
            onGameStart: () => {
                gameStatusEl.textContent = 'æ¸¸æˆä¸­... ä½¿ç”¨æ–¹å‘é”®æˆ–WASDæ§åˆ¶';
                startBtn.classList.add('hidden');
                speedSlider.disabled = true; // æ¸¸æˆä¸­ç¦ç”¨é€Ÿåº¦æ»‘å—
            }
        });

        // å¼€å§‹æ¸¸æˆæŒ‰é’®
        startBtn.addEventListener('click', () => {
            // åº”ç”¨å½“å‰é€Ÿåº¦è®¾ç½®
            const level = speedSlider.value;
            game.setSpeed(speedLevels[level].ms);
            game.start();
        });

        // ç©ºæ ¼é”®å¼€å§‹/é‡æ–°å¼€å§‹
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !game.isRunning) {
                e.preventDefault();
                game.start();
            }
        });

        // é€€å‡ºç™»å½•
        logoutBtn.addEventListener('click', () => {
            Auth.logout();
            window.location.href = 'login.html';
        });

        // åˆå§‹åŒ–
        initUserInfo();
        updateLeaderboard();
    </script>
</body>

</html>